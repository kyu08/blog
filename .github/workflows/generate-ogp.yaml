name: Generate OGP Images

on:
  workflow_dispatch: # 手動実行を許可
  pull_request:

jobs:
  generate-ogp:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate OGP images
        run: npm run generate-ogp

      - name: Check for changes
        id: git-check
        run: |
          if ! git diff --exit-code content/posts/**/cover.png; then
            echo "changed=true" >> $GITHUB_OUTPUT
            # 変更されたファイルのリストを取得
            CHANGED_FILES=$(git diff --name-only content/posts/**/cover.png | tr '\n' ',' | sed 's/,$//')
            echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push OGP images
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add content/posts/**/cover.png
          git commit -m "chore: update OGP images"
          git push origin HEAD:${{ github.head_ref }}

      - name: Comment PR with OGP images
        if: steps.git-check.outputs.changed == 'true' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # コメント本文を作成
          COMMENT="## OGP画像が更新されました\n\n"

          # 変更されたファイルごとに画像を表示
          IFS=',' read -ra FILES <<< "${{ steps.git-check.outputs.files }}"
          for file in "${FILES[@]}"; do
            # ファイルパスから記事名を抽出
            POST_NAME=$(echo "$file" | sed 's|content/posts/||' | sed 's|/cover.png||')
            IMAGE_URL="https://github.com/${{ github.repository }}/raw/${{ github.head_ref }}/${file}"
            COMMENT="${COMMENT}### ${POST_NAME}\n![${POST_NAME}](${IMAGE_URL})\n\n"
          done

          # PRにコメントを投稿
          echo -e "$COMMENT" | gh pr comment ${{ github.event.pull_request.number }} --body-file -

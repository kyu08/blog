<!DOCTYPE html>
<html lang="ja">
<head>
  
    <title>Makefileに定義されたtargetをfzfで選択して実行するCLIツールをRustでつくった :: blog.kyu08.com</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Makefileに定義されたtargetをfzfで選択して実行するCLIツールをRustでつくった。 https://github.com/kyu08/fzf-make こんな感じで動く。 fzf-makeがや" />
<meta name="keywords" content=", " />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.kyu08.com/posts/fzf-make/" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-BDQ408J45J"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-BDQ408J45J', { 'anonymize_ip': false });
}
</script>





  
  
  
  
  
  <link rel="stylesheet" href="https://blog.kyu08.com/styles.css">



<link rel="stylesheet" href="https://blog.kyu08.com/style.css">



  <link rel="shortcut icon" href="https://blog.kyu08.com/favicon.ico">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="kyu08_" />



<meta property="og:locale" content="ja" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Makefileに定義されたtargetをfzfで選択して実行するCLIツールをRustでつくった">
<meta property="og:description" content="Makefileに定義されたtargetをfzfで選択して実行するCLIツールをRustでつくった。 https://github.com/kyu08/fzf-make こんな感じで動く。 fzf-makeがや" />
<meta property="og:url" content="https://blog.kyu08.com/posts/fzf-make/" />
<meta property="og:site_name" content="blog.kyu08.com" />

  
  
  <meta property="og:image" content="https://blog.kyu08.com">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-03-31 01:15:48 &#43;0900 &#43;0900" />












<script async src="https://www.googletagmanager.com/gtag/js?id=G-BDQ408J45J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '{{ . }}');
</script>




</head>
<body class="orange">


<div class="container headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    blog.kyu08.com
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about" >About</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.kyu08.com/posts/fzf-make/">Makefileに定義されたtargetをfzfで選択して実行するCLIツールをRustでつくった</a>
  </h1>
  <div class="post-meta">
    
      <time class="post-date">
        2023-03-31 ::
        
          [Updated :: 2023-03-31]
        
      </time>
    
    
      <span class="post-author">kyu08</span>
    
    
      <span class="post-reading-time">:: 5 min read (2158 words)</span>
    
  </div>

  
    <span class="post-tags">
      
      #<a href="https://blog.kyu08.com/tags/rust/">rust</a>&nbsp;
      
      #<a href="https://blog.kyu08.com/tags/cli/">cli</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <p>Makefileに定義されたtargetをfzfで選択して実行するCLIツールをRustでつくった。</p>
<p><a href="https://github.com/kyu08/fzf-make">https://github.com/kyu08/fzf-make</a></p>
<p>こんな感じで動く。</p>
<p><img src="fzf-make-demo.gif" alt="fzf-make-demo"></p>
<h2 id="fzf-makeがやっていること">fzf-makeがやっていること<a href="#fzf-makeがやっていること" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<ol>
<li><code>Makefile</code>からtargetを正規表現で抜き出す</li>
<li><code>skim</code>(※)に実行オプションとtargetたちを渡す</li>
<li><code>skim</code>がプレビューウィンドウ付きのfuzzy-finderを表示</li>
<li><code>skim</code>から選択されたtargetが返ってくるので<code>make ${target}</code>を実行</li>
</ol>
<p>基本的な動作はすべて<code>skim</code>任せになっていてRust側でやっているのは<code>skim</code>とのやりとりくらいになっている。</p>
<p>※<a href="https://github.com/lotabout/skim">lotabout/skim</a>&hellip;Rust製のfuzzy-finder。Rustのライブラリとして利用することもできる。</p>
<p>(makeの文法が思ったより多彩っぽかったので自分が必要とするごく簡単なユースケース以外をカバーするのは<a href="https://twitter.com/kyu08_/status/1639986936407531525">早々に諦めた。</a>(makeで1冊本が書けるぐらいだしそれはそうという感じではある))</p>
<p>brewコマンドでインストールできるので気になる方はぜひ。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>brew tap kyu08/tap
</span></span><span style="display:flex;"><span>brew install kyu08/tap/fzf-make
</span></span></code></pre></div><p>ソースも公開しているので、「こう書くといいよ」とかバグとかありましたらぜひissueやPRで教えてください。</p>
<p><a href="https://github.com/kyu08/fzf-make">https://github.com/kyu08/fzf-make</a></p>
<h2 id="実装">実装<a href="#実装" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>上述の通り処理の大部分はskim任せになっている。(書いたコードはテストを含めても200行程度)</p>
<p>ただskimをライブラリとして利用する実装サンプルがあまりなかったのがちょっと大変だった。特にプレビューウィンドウの表示にfzfの候補文字列を変数としたシェルコマンドの形で渡すことができることに気づくまでに時間がかかった</p>
<p>↓の<code>{}</code>にtarget名が入るイメージ。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-rust" data-lang="rust"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> preview_command <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;line=$(bat Makefile | grep -nE &#39;^{}\s*:&#39; | sed -e &#39;s/:.*//g&#39;); bat --style=numbers --color=always --line-range $line: --highlight-line $line Makefile&#34;</span>;
</span></span></code></pre></div><p><a href="https://github.com/kyu08/fzf-make/blob/3a627d0a1aa75b1bf1ff87f3443f63393afbcf10/src/misc.rs#L18">https://github.com/kyu08/fzf-make/blob/3a627d0a1aa75b1bf1ff87f3443f63393afbcf10/src/misc.rs#L18</a></p>
<p>あとはgoでいつもやっている感じでテーブル駆動テストっぽくテストを書いてみた。可読性も保守性も高いので割と気に入っている。</p>
<p><a href="https://github.com/kyu08/fzf-make/blob/3a627d0a1aa75b1bf1ff87f3443f63393afbcf10/src/misc.rs#L145">https://github.com/kyu08/fzf-make/blob/3a627d0a1aa75b1bf1ff87f3443f63393afbcf10/src/misc.rs#L145</a></p>
<h2 id="動機">動機<a href="#動機" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<ul>
<li>Rustが書きたかった。(以上)</li>
</ul>
<p>最近Rustのやっていきが高まっており、<a href="https://doc.rust-jp.rs/book-ja/">The Rust Programming Language</a> を1周したので何か作ってみるぞーという機運とMakefileのターゲットをfuzzy-finderで絞り込めたら便利そうだなーという気持ちが重なったのでRustでfzf-makeを作ってみた。 (あとはskimの存在を知っていたのも大きい。)</p>
<p>自分が欲しいCLIツールを手に入れつつRustの経験が積めたのでよかった。</p>
<p>ちなみにRustに入門した直接的(?)なきっかけとしてはこのスライドを目にして、「Elmっぽい！楽しそう！」と思ったのが発端だった。Rustに興味を持っている人はぜひ読んでみて欲しい。</p>
<p><a href="https://speakerdeck.com/estie/man-wochi-siteshi-merurust">満を持して始める Rust</a></p>
<h2 id="rustを触ってみて感じたこと">Rustを触ってみて感じたこと<a href="#rustを触ってみて感じたこと" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Rustを触る前に持っていた印象は「コンパイルが通りずらく、安全性が高い」「関数型っぽい」という感じだった。</p>
<p>実際に学んでみた印象は次のような感じ。</p>
<ul>
<li>関数型っぽい書き心地
<ul>
<li>特にenumとパターンマッチング,Option型 ,Result型, 式指向な考え方などの関数型っぽい言語機能や極力データをイミュータブルに扱う思想などが心地よかった。筆者が大好きな言語であるElm(ウェブブラウザベースのGUIを作成するための純粋関数型)の好きな部分をほとんど含んでたのでElmに近い感覚で書くことができた。(もちろん慣れてないこともあってElmよりも全然難しかったけど)</li>
<li>(Elmが気になる方は<a href="https://guide.elm-lang.jp/">Elm Guide</a>がおすすめです)</li>
</ul>
</li>
<li>↑に近いがNull安全なことに加えて所有権などの概念のおかげでコンパイルが通りさえすればちゃんと動いてくれるという安心感がある。
<ul>
<li>リファクタもやりやすそう。(enumにバリアントを追加したとき、パターンマッチの全箇所を修正しないとコンパイルが通らなかったりすると思うので)</li>
</ul>
</li>
<li>開発体験が良い
<ul>
<li>エラーメッセージがとても丁寧。「ここがこう悪いで〜」とか「ここをこう直すとええで〜」みたいなことまでエラーメッセージに書いてくれてあるホスピタリティに感動した。こういったところもRustが生産性が高いと言われる所以なのかもしれない。</li>
</ul>
</li>
<li>コミュニティの初学者をサポートする姿勢がすごい
<ul>
<li>RustのOSSプロジェクトへのcontributionについては <a href="https://zenn.dev/fraternite/articles/4e11063bf05aac">rust-lang/rustへのcode contributionをはじめからていねいに</a> が詳しいが、Rust製のOSSプロジェクトには<code>E-mentor</code>というタグがありissueを進めるに当たってメンターが指針を記してくれているらしい。（<a href="https://github.com/rust-lang/rust/issues/109099">https://github.com/rust-lang/rust/issues/109099</a> これとかすごい。）</li>
<li>いつかRustのOSSプロジェクトにもcontributionしてみたい</li>
</ul>
</li>
<li>他の言語と比べて動くものをつくるまでに必要な学習コストは高いとは思うがRustをちゃんと書けるようになれば生産性高く安全なコードが書けると思うので必ずしも学習コストが高いとは言えないのかもしれない。（他の言語でも安全なコードを書くためには一定の学習や経験が必要だろうし）（※想像で喋っています）</li>
</ul>
<p>総じて開発体験は良かったのでこれからもゆるゆるとRustの学習は続けていきたい。</p>
<h2 id="余談">余談<a href="#余談" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>テスト実行に <a href="nextest-rs/nextest">https://github.com/nextest-rs/nextest</a> を使ってみたがテスト結果が見やすくて便利だった。</p>
<p><code>cargo run</code>の結果
<img src="cargo-run.png" alt="cargo run"></p>
<p><code>cargo nextest run</code>の結果
<img src="nextest-run.png" alt="cargo nextest run"></p>
<p>カラフルで見やすい。</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="https://blog.kyu08.com/posts/fzf-bookmark-opener/">
                <span class="button__text">yamlに定義したbookmarkをfzfで選択してブラウザで開くくんを作った</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>blog.kyu08.com</span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>

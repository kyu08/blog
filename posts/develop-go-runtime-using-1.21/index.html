<!DOCTYPE html>
<html lang="ja">
<head>
  
    <title>go/src/cmdでLSPが動作するようにするメモ :: blog.kyu08.com</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="gc(go compiler)のコード（具体的にはgo/src/cmd/compile 配下）を読むために必要な手順があったのでメモ代わりに書いておく。" />
<meta name="keywords" content="go, neovim" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.kyu08.com/posts/develop-go-runtime-using-1.21/" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-BDQ408J45J"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-BDQ408J45J', { 'anonymize_ip': false });
}
</script>




  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/code.min.00125962708925857e7b66dbc58391d55be1191a3d0ce2034de8c9cd2c481c36.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/main.min.0832e53463742bab51a209f71625f505d20a9662c72e6fc66248658a02e0f4b9.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/menu.min.48f42ef526b5c0c074cc696ab2e25a4316fdb58c4f42be6ee88c83fed3fe3c90.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/post.min.d551b54605ea87772c5eb05bf68219699a011687df301682a1006e8811253df9.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/prism.min.9023bbc24533d09e97a51a0a42a5a7bfe4c591ae167c5551fb1d2191d11977c0.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/syntax.min.cc789ed9377260d7949ea4c18781fc58959a89287210fe4edbff44ebfc1511b6.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/terminal.min.08e270ae3e1713b186bb6da1e872f4ed403127d18ae635cf9c981c6633809797.css">

  
  <link rel="stylesheet" href="https://blog.kyu08.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">




<link rel="stylesheet" href="https://blog.kyu08.com/style.css">


<link rel="shortcut icon" href="https://blog.kyu08.com/favicon.png">
<link rel="apple-touch-icon" href="https://blog.kyu08.com/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="kyu08_" />



<meta property="og:locale" content="ja" />
<meta property="og:type" content="article" />
<meta property="og:title" content="go/src/cmdでLSPが動作するようにするメモ">
<meta property="og:description" content="gc(go compiler)のコード（具体的にはgo/src/cmd/compile 配下）を読むために必要な手順があったのでメモ代わりに書いておく。" />
<meta property="og:url" content="https://blog.kyu08.com/posts/develop-go-runtime-using-1.21/" />
<meta property="og:site_name" content="blog.kyu08.com" />

  
  
  <meta property="og:image" content="https://blog.kyu08.com/cover.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-09-12 00:12:17 &#43;0900 &#43;0900" />









<link rel="author" href="http://www.hatena.ne.jp/kyu08/" />




<script async src="https://www.googletagmanager.com/gtag/js?id=G-BDQ408J45J"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '{{ . }}');
</script>




</head>
<body>


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    blog.kyu08.com
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/index.xml">RSS</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/about" >About</a></li>
        
      
        
          <li><a href="/index.xml" >RSS</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.kyu08.com/posts/develop-go-runtime-using-1.21/">go/src/cmdでLSPが動作するようにするメモ</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023/09/12</time>
      
    <span class="post-reading-time">1 min read (416 words)</span></div>

  
  
  <img src="https://blog.kyu08.com/cover.png"
    class="post-cover"
    alt="go/src/cmdでLSPが動作するようにするメモ"
    title="Cover Image" />


  
    <div class="table-of-contents">
      <h2>
        目次
      </h2>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#packagesload-error-err-exit-status-2-stderr-panic-runtime-error-index-out-of-range--1--goroutine-1-running-cmdgointernallistcollectdepserrors"><code>packages.Load error: err: exit status 2: stderr: panic: runtime error: index out of range [-1]  goroutine 1 [running]: cmd/go/internal/list.collectDepsErrors...</code></a></li>
    <li><a href="#error-loading-workspace-folders-expected-1-got-0-failed-to-load-view-for-filepathtorepogosrccmd-err-exit-status-1-stderr-go-downloading-go122-darwinarm64-go-download-go122-for-darwinarm64-toolchain-not-available"><code>Error loading workspace folders (expected 1, got 0) failed to load view for file:///path/to/repo/go/src/cmd: err: exit status 1: stderr: go: downloading go1.22 (darwin/arm64) go: download go1.22 for darwin/arm64: toolchain not available</code></a></li>
    <li><a href="#this-file-is-within-module--which-is-not-included-in-your-workspace-to-fix-this-problem-you-can-add-a-gowork-file-that-uses-this-directory-see-the-documentation-for-more-information-on-setting-up-your-workspace-httpsgithubcomgolangtoolsblobmastergoplsdocworkspacemd"><code>This file is within module &quot;.&quot;, which is not included in your workspace. To fix this problem, you can add a go.work file that uses this directory. See the documentation for more information on setting up your workspace: https://github.com/golang/tools/blob/master/gopls/doc/workspace.md.</code></a></li>
    <li><a href="#ということで">ということで</a></li>
  </ul>
</nav>
    </div>
  

  <div class="post-content"><div>
        <p>gc(go compiler)のコード（具体的には<a href="https://github.com/golang/go/tree/master/src/cmd/compile" target="_blank" ><code>go/src/cmd/compile</code></a>
配下）を読むために必要な手順があったのでメモ代わりに書いておく。neovimでしか確認していないが他のエディタでもきっと同じような感じなはず。</p>
<h2 id="packagesload-error-err-exit-status-2-stderr-panic-runtime-error-index-out-of-range--1--goroutine-1-running-cmdgointernallistcollectdepserrors"><code>packages.Load error: err: exit status 2: stderr: panic: runtime error: index out of range [-1]  goroutine 1 [running]: cmd/go/internal/list.collectDepsErrors...</code><a href="#packagesload-error-err-exit-status-2-stderr-panic-runtime-error-index-out-of-range--1--goroutine-1-running-cmdgointernallistcollectdepserrors" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>というエラーを出力してLSPが停止する。go1.21.0のバグだった模様。</p>
<p><a href="https://github.com/golang/go/issues/61816" target="_blank" >https://github.com/golang/go/issues/61816</a>
</p>
<p>ローカルのgoをgo1.21.1に上げることでエラーが解決した。</p>
<h2 id="error-loading-workspace-folders-expected-1-got-0-failed-to-load-view-for-filepathtorepogosrccmd-err-exit-status-1-stderr-go-downloading-go122-darwinarm64-go-download-go122-for-darwinarm64-toolchain-not-available"><code>Error loading workspace folders (expected 1, got 0) failed to load view for file:///path/to/repo/go/src/cmd: err: exit status 1: stderr: go: downloading go1.22 (darwin/arm64) go: download go1.22 for darwin/arm64: toolchain not available</code><a href="#error-loading-workspace-folders-expected-1-got-0-failed-to-load-view-for-filepathtorepogosrccmd-err-exit-status-1-stderr-go-downloading-go122-darwinarm64-go-download-go122-for-darwinarm64-toolchain-not-available" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p><code>src/cmd/go.mod</code> の <code>go 1.22</code>を<code>go 1.21.0</code>に書き換えることで解決した。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>diff --git a/src/cmd/go.mod b/src/cmd/go.mod
</span></span><span style="display:flex;"><span>index 1eaad916ff..da12b2adff 100644
</span></span><span style="display:flex;"><span><span style="color:#f92672">--- a/src/cmd/go.mod
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/src/cmd/go.mod
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -1,6 +1,6 @@
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> module cmd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-go 1.22
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+go 1.21.0
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>
</span></span><span style="display:flex;"><span> require (
</span></span><span style="display:flex;"><span>  github.com/google/pprof v0.0.0-20230811205829-9131a7e9cc17
</span></span></code></pre></div><h2 id="this-file-is-within-module--which-is-not-included-in-your-workspace-to-fix-this-problem-you-can-add-a-gowork-file-that-uses-this-directory-see-the-documentation-for-more-information-on-setting-up-your-workspace-httpsgithubcomgolangtoolsblobmastergoplsdocworkspacemd"><code>This file is within module &quot;.&quot;, which is not included in your workspace. To fix this problem, you can add a go.work file that uses this directory. See the documentation for more information on setting up your workspace: https://github.com/golang/tools/blob/master/gopls/doc/workspace.md.</code><a href="#this-file-is-within-module--which-is-not-included-in-your-workspace-to-fix-this-problem-you-can-add-a-gowork-file-that-uses-this-directory-see-the-documentation-for-more-information-on-setting-up-your-workspace-httpsgithubcomgolangtoolsblobmastergoplsdocworkspacemd" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>リンク先のドキュメントの手順に従って<code>go.work</code>を作成する。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>// src/cmd ディレクトリで
</span></span><span style="display:flex;"><span>go work init
</span></span><span style="display:flex;"><span>go work use ./compile
</span></span></code></pre></div><h2 id="ということで">ということで<a href="#ということで" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>無事LSPを動作させることができた。</p>
<p><img src="running-lsp-on-go-runtime-repository.webp" alt="running-lsp-on-go-runtime-repository.webp"></p>
<p>これでgo本体のコードがサクサク読めるぞー。</p>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">Read other posts</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="https://blog.kyu08.com/posts/github-pr-list/" class="button inline prev">
        GitHubで自分がOSSに送ったPR一覧を表示するやつ
      </a>
    
    
      ::
    
    
      <a href="https://blog.kyu08.com/posts/sponsored-neovim/" class="button inline next">
        GitHub Sponsorsを通してNeovimに寄付をした
      </a>
    
  </div>
</div>


  

  
    <script src="https://utteranc.es/client.js"
        repo="kyu08/blog-comments"
        issue-term="pathname"
        theme="preferred-color-scheme"
        crossorigin="anonymous"
        async>
</script>

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>blog.kyu08.com</span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>


<font color="#808080">
  <span>
    This site uses Google Analytics for access analysis.
    Google Analytics uses cookies to collect traffic data, but this traffic data is collected anonymously and does not personally identify you.
    Cookies can be disabled in your browser.
  </span>
</font>


  
</div>

</body>
</html>
